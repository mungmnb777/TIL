# 5. 마이크로벤치마킹과 통계

## 5.1. 자바 성능 측정 기초

> 벤치마크에서 수치는 별로 중요하지 않습니다.
이 수치들로부터 어떤 모델을 이끌어 내느냐, 하는 점이 관건입니다.
> 

우리는 벤치마크로 공정한 테스트를 하는 것이 목적이다. 따라서 시스템의 어느 한 곳만 변경하고 다른 외부 요인은 벤치마크 안에 두고 통제하는 것이 좋다.

- 자바 플랫폼을 벤치마크하는 경우 고려해야 할 사항
    - JVM 웜업
    - JIT 컴파일러의 최적화
    - GC
    - 멀티 쓰레드 환경에서 테스트하는 경우
- 해결 방안
    - 시스템 전체를 벤치마크한다. 저수준 수치는 무시한다.
    - 연관된 저수준의 결과를 의미있게 비교하기 위해서 공통 프레임워크를 사용한다. 해당 툴은 최적화 및 다른 외부 제어 변수가 잘 관리해준다.

<br>

## 5.2. JMH

대부분 애플리케이션은 마이크로벤치마킹은 적합하지 않다. 개발자는 작은 코드를 세세히 뜯어보며 원인을 찾으려고 하지만, 이 정도 수준으로 벤치마킹하는 것은 몹시 어렵고 `베어 트랩`에 빠질 수도 있다.

마이크로벤치마킹을 하는 주요 유즈케이스는 다음과 같다.

- 사용 범위가 넓은 범용 라이브러리 코드를 개발한다.
    - 범용 라이브러리는 원래 적용 범위가 넓기 때문에 전통적인 성능/용량 테스트 기법 대신 마이크로벤치마킹을 쓸 수 밖에 없는 때가 있다.
- OpenJDK 또는 다른 자바 플랫폼 구현체를 개발한다.
- 지연에 극도로 민감한 코드를 개발한다.
    - 자신이 개발한 애플리케이션과 극단적 유즈케이스에 가장 잘 맞는 알고리즘/기법을 선택하기 위해 마이크로벤치마크를 활용한다. 보통 저지연 금융 거래 분야에서 쓰인다.
- 블랙홀
    - 런타임에 죽은 코드를 제거하는 최적화를 못 하게 한다.
    - 반복되는 계산을 상수 폴딩하지 않게 만든다.
    - 값을 읽거나 쓰는 행위가 현재 캐시 라인에 영향을 끼치는 잘못된 공유 현상을 방지한다.
    - 쓰기 장벽으로부터 보호한다.

<br>

## 5.3. JVM 성능 통계

### 5.3.1. 오차 유형

엔지니어가 자주 접하는 오차의 주된 근원은 두 가지이다.

- 랜덤 오차 : 측정 오차 또는 무관계 요인이 어떤 상관관계 없이 결과에 영향을 미친다.
    - 정밀도 : 랜덤 오차를 나타내는 용어. 정밀도가 높으면 랜덤 오차가 낮다.
    - 소프트웨어에서 랜덤 오차의 근원은 오직 운영 환경이다.
- 계통 오차 : 원인을 알 수 없는 요인이 상관관계 있는 형태로 측정에 영향을 미친다.
    - 정확도 : 계통 오차의 수준을 나타내는 용어. 정확도가 높으면 계통 오차가 낮다.
    - 허위 상관 : `상관은 인과를 나타내지 않는다.` 두 변수가 비슷하게 움직인다고 해서 이들 사이에 연결 고리가 있다고 볼 수 없다.
    [http://tylervigen.com/spurious-correlations](http://tylervigen.com/spurious-correlations)
    - JVM과 성능 분석 영역에서 그럴싸해 보이는 연결고리와 상관관계만 보고 측정값 간의 인과관계를 넘겨짚지 않도록 조심해야 한다.