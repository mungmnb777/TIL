# 가상 쓰레드

날짜: 2023년 11월 7일
카테고리: java

## 플랫폼 쓰레드

- 기존의 자바 쓰레드
- `start()` 메서드를 통해 운영체제에 쓰레드 생성을 요청한다.
- 이후 JVM에 스택 공간을 할당 받고, 쓰레드 정보와 로컬 변수를 저장한다.

### 단점

- 비용이 크고 무겁다.
- 각 플랫폼 쓰레드는 운영체제 쓰레드와 1:1 매칭된다.

## 가상 쓰레드

- JDK 21에 공개됨
- 운영체제가 아닌 JVM에 의해 관리된다.

### 어떻게 CPU에 의해 스케줄링 될까?

1. 가상 쓰레드를 생성한 시점에 JVM이 내부 플랫폼 쓰레드 풀을 생성한다.
2. 가상 쓰레드 A를 실행시키려 할 때, 풀 내 플랫폼 쓰레드 중 하나에 마운트한다.
    - 가상 쓰레드가 플랫폼 쓰레드에 마운트 되면 해당 플랫폼 쓰레드를 `캐리어 쓰레드`라고 부른다.
3. 가상 쓰레드 실행이 끝나면 JVM은 캐리어에서 쓰레드 마운트를 해제하고 다른 쓰레드가 사용할 수 있게 한다.
    - 만약 가상 쓰레드 실행이 끝나지 않았지만, 더 이상 진행할 수 없는 순간에는 마운트 해제 후 현재 상태를 힙에 저장한다.
4. 사용이 끝난 가상 쓰레드 객체는 GC에 의해 청소된다.

### 장점

- 쓰레드가 오랜 시간 기다려야 하는 작업이 포함된 경우 성능에서 유리하다.
    - 컨텍스트 스위칭 X (마운트, 언마운트에 드는 비용은 컨텍스트 스위칭보다 싸다.)