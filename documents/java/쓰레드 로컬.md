# 쓰레드 로컬

## 1. 소개

다중 쓰레드 환경에서 상태를 가진 어떤 리소스를 동시에 접근하고, 수정하게 되면 그 리소스에는 동시성 문제가 발생할 수 있다.

여기서 동시성 문제를 간단히 한가지 예로 설명하자면, 우선 `Thread-A`와 `Thread-B`가 `nameStore`이라는 싱글턴 객체를 동시에 접근해서 새로운 이름을 저장하는 상황을 하나 가정해보자. 이 때 이름을 저장하고 저장한 이름을 바로 조회하는 것까지가 하나의 서비스 로직이다.

1. `Thread-A`가 `userA`를 `nameStore`에 저장했다.
2. `Thread-B`가 `userB`를 `nameStore`에 저장했다.
3. `Thread-A`가 `userB`를 `nameStore`에서 조회했다.
4. `Thread-B`가 `userB`를 `nameStore`에서 조회했다.

이 때, 우리는 3번 과정에서 `Thread-A`는 `userA`를 조회할 것이라고 예상했지만, 결과는 `userB`를 조회하게 되었다. 이렇게 쓰레드가 동시에 리소스를 접근하고 수정해서 예상치 못한 결과를 만들어내는 것이 바로 동시성 문제이다.

이 때, 싱글턴 객체를 사용하면서 동시성 문제를 해결하기 위한 방법이 바로 `쓰레드 로컬`이다.

## 2. 사용법

자바에서는 다음과 같이 사용한다.

1. ThreadLocal 객체를 생성한다.
2. ThreadLocal.set() 메서드를 이용해서 현재 쓰레드의 로컬 변수에 값을 저장한다.
3. ThreadLocal.get() 메서드를 이용해서 현재 쓰레드의 로컬 변수의 값을 읽어온다.
4. ThreadLocal.remove() 메서드를 이용해서 현재 쓰레드의 로컬 변수 값을 삭제한다.

위의 `nameStore`로 예를 들어보겠다.

```java
// ThreadLocal 객체를 생성한다.
ThreadLocal<NameStore> threadLocal = new ThreadLocal<>();

// set() 메서드를 이용해서 값을 저장한다.
threadLocal.set(new NameStore());

// get() 메서드를 이용해서 쓰레드 로컬 변수의 값을 가져온다.
NameStore nameStore = threadLocal.get();

// 사용후 remove() 메서드를 이용해서 변수의 값을 삭제한다.
threadLocal.remove()
```

## 3. 활용

쓰레드와 관련된 코드에서 파라미터를 사용하지 않고 객체를 `전파`하기 위한 용도로 주로 사용된다. 즉, 다른 계층에 그 객체의 상태를 전달도 하고, 수정도 필요한데 다른 쓰레드로부터의 접근은 막아야할 때 사용하면 좋다.

## 4. 주의사항

쓰레드 풀을 사용하는 환경일 경우, 쓰레드 로컬을 제대로 제거하지 않으면 추후에 다른 쓰레드가 접근해서 쓰레드 로컬의 리소스를 조회할 수 있다.

즉, `userA`의 정보가 제대로 삭제되지 않고 `Thread-A`를 풀에 반환했다고 가정하자. `userC`가 추후에 `nameStore`를 사용하기 위해 `Thread-A`를 통해 접근했을 때 `userA`의 정보가 그대로 남아있기 때문에 보안 문제가 발생할 수 있다.

그렇기 때문에 쓰레드 로컬을 사용하고 쓰레드를 반환하는 경우 꼭 `remove()` 메서드를 이용해서 확실히 제거해야만 한다.
