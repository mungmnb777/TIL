# 애플리케이션 배포를 위한 고급 설정

날짜: 2023년 3월 7일
책: 시작하세요! 도커/쿠버네티스
카테고리: infra

## limits

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: resource-limit-pod
  labels:
    name: resource-limit-pod
spec:
  containers:
  - name: nginx
    image: nginx:latest
    resources:
      limits:
        memory: "256Mi"
        cpu: "1000m"
```

- spec.containers.resources.limits : 메모리와 CPU 리소스를 제한할 수 있음 (상한선)

## requests

- 오버커밋 : 사용할 수 있는 자원보다 더 많은 양을 할당 → 전체 자원의 사용률 증가
- spec.containers.resources.limits : 컨테이너가 최소한으로 보장받아야하는 자원의 양

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: resource-limit-with-request-pod
  labels:
    name: resource-limit-with-request-pod
spec:
  containers:
  - name: nginx
    image: nginx:latest
    resources:
      limits:
        memory: "256Mi"
        cpu: "1000m"
      requests:
        memory: "128Mi"
        cpu: "500m"
```

- 이 내용을 조합해보면 메모리는 최소 128메가, 그리고 여유가 있다면 256메가까지는 사용할 수 있다.
- CPU는 최소 500밀리, 여유가 있다면 1000밀리코어(1 cpu)까지 사용할 수 있다.
- 노드의 총 자원의 크기보다 더 많은 request를 할당할 수 없다. 쿠버네티스의 스케줄러는 pod의 request만큼 여유가 있는 노드를 선택한다.

## 메모리 자원 사용량 제한 원리

- CPU의 경합이 발생하면 스로틀을 이용해 사용을 제한할 수 있다.
- 메모리는 이미 데이터가 적재되어있기 때문에 압축할 수 없다.
    
    → 가용 메모리를 확보하기 위해 우선 순위가 낮은 pod 또는 프로세스를 강제 종료한다. 이후 다른 노드로 옮겨가게 되는데 이를 `퇴거(Eviction)`라고 한다.
    
- oom_score : 낮을수록 강제 종료 될 가능성이 작다. → 핵심 프로세스는 점수를 낮게 부여된다는데, 쿠버네티스가 어떤게 핵심 프로세스인지 어떻게 알 수 있을까?

## QoS

- Guaranteed 클래스 : Requests와 Limits가 완전히 동일할 때 적용되는 클래스
    - 기본 OOM 점수가 -998 → 웬만하면 강제로 종료되지 않음
- BestEffort 클래스 : resources 항목을 사용하지 않으면 적용되는 클래스
    - 노드에 존재하는 모든 자원을 사용할 수도 있지만, 자원을 전혀 사용하지 못할 수도 있다.
- Burstable 클래스 : Limits가 Requests보다 큰 파드에 적용되는 클래스
- 우선순위
    - Guaranteed → Burstable → BestEffort
    - 중요한 애플리케이션은 Guaranteed로 설정하는게 좋을듯

## ResourceQuota

- 네임스페이스에서 사용할 수 있는 자원 사용량을 제한

## LimitRange

- 특정 네임스페이스에 할당되는 자원의 범위 또는 기본값 설정

## 쿠버네티스 스케줄링

- kubelet, watch? 실시간으로 API 서버를 감시하는 느낌
- 노드 필터링, 노드 스코어링 - 노드를 선택하는 기법
- nodeSelector - 라벨의 키-값을 이용해 스케줄링
- Node Affinity
    - requiredDuringSchedulingIgnoredDuringExecution : 반드시 만족해야함
    - prefferedDuringSchedulingIgnoredDuringExecution : 해당 조건을 만족하는 노드를 더 선호함
- Pod Affinity : Topology Key에 적힌 라벨에 해당하는 그룹에 파드 생성
- PodAnti Affinity : Pod Affinity와 반대