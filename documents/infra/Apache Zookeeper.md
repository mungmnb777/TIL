# Apache Zookeeper

날짜: 2023년 9월 26일
카테고리: infra

## 용어

- 노드 : 분산 시스템에 동작하는 시스템에서 실행되는 프로세스
- 클러스터 : 서로 연결된 노드의 모음

## 클러스터에 어떻게 작업을 맡길까?

- 분산 시스템의 큰 장점은 작업을 병렬화하고 각 노드가 공동의 목표를 위해 독립적으로 동작하도록 할 수 있다.
- 이 작업을 수동으로 분배해서 각 노드에 별도의 작업을 할당할 수 있지만, 이런 방식에는 확장성이 떨어진다.
- 다른 방식은 하나의 노드를 선택해 마스터로 지정할 수 있다.
    - 마스터로 지정된 노드는 작업 분배와 결과 수집을 담당하게 된다.
    - 이 방식의 문제는 마스터 노드를 포함한 모든 노드가 언제든 작업 수행에 실패할 수 있다.
    - 마스터 노드가 작업을 배포하지 않거나 결과를 수집하지 않으면 클러스터 전체가 동작하지 않게 된다.
- 다른 방식은 마스터를 모든 노드들이 직접 선택하는 알고리즘을 구축하는 것이다.
    - 마스터 노드가 작업을 수행할 수 없으면 나머지 노드들이 리더를 다시 선택한다.

## Master-Worker 아키텍처의 문제점

- 마스터 선출을 자동화하는 것을 매우 어려운 작업이다.
- 각 노드는 자기 자신만 인식하고 클러스터의 다른 구성원에 대해는 알지 못한다.
    
    → 따라서 서비스 레지스트리와 서비스 디스커버리 솔루션이 필요하다.
    
- 장애 감지 매커니즘이 필요하다. 마스터 노드를 사용할 수 없게 되면 클러스터의 다른 노드들에게 알려야한다.

## Apache Zookeeper

- 이러한 사항들을 매번 구현해주는 것은 너무 번거롭다. 따라서 이러한 일을 해주는 오픈 소스가 바로 Apache Zookeeper이다.
- 주키퍼는 그 자체로 분산 시스템이며 호환성 높은 알고리즘을 사용함으로써 높은 가용성과 신뢰성을 보장한다.
- 보통 3개 이상의 홀수 개의 노드를 가진 클러스터를 사용한다.

## 리더 선출 알고리즘

1. 주키퍼와 연결된 모든 노드가 리더 후보에 자원한다. 각 노드는 선거에 출마하기 위해 자신을 나타내는 Z노드를 election 부모 노드 밑에 추가한다. 주키퍼는 전체 순서를 관리하므로 추가 순서에 따라 각 Z노드의 이름을 지정한다.
2. 각 노드는 Z노드 생성을 마친 후 election이라는 부모 노드에 현재 자식 노드들을 물어본다. 노드 순서는 주키퍼가 우리에게 제공하기 때문에 각 노드는 election 부모 노드의 자식 노드를 자신이 Z노드를 생성하기 전에 생성된 모든 Z노드를 볼 수 있다.
3. 현재 노드가 만든 Z노드의 숫자가 가장 작다면 해당 노드가 리더라는 것을 알 수 있다.반대로 현재 노드인 Z노드의 숫자가 가장 작지 않다면 그 노드는 리더가 아니다. 그런 노드는 리더 노드의 지시를 기다린다.